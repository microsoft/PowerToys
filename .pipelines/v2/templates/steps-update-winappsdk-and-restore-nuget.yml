parameters:
  - name: versionNumber
    type: string
    default: 1.6
  - name: useExperimentalVersion
    type: boolean
    default: false

steps:
- task: PowerShell@2
  displayName: 'Configure NuGet'
  inputs:
    targetType: 'inline'
    script: |
      $nugetConfigPath = "$(Build.SourcesDirectory)\nuget.config"
      $localPackagesPath = "$(Build.SourcesDirectory)\localpackages\output"
      
      # Ensure the directory exists so it's a valid source
      New-Item -ItemType Directory -Path $localPackagesPath -Force | Out-Null
      
      Write-Host "Modifying $nugetConfigPath..."
      [xml]$xml = Get-Content -Path $nugetConfigPath
      
      # Add localpackages source
      $packageSourcesNode = $xml.configuration.packageSources
      if (-not $packageSourcesNode.SelectSingleNode("add[@key='localpackages']")) {
          $addNode = $xml.CreateElement("add")
          $addNode.SetAttribute("key", "localpackages")
          $addNode.SetAttribute("value", $localPackagesPath)
          $packageSourcesNode.AppendChild($addNode) | Out-Null
      }
      
      # Update packageSourceMapping to include localpackages for WindowsAppSDK
      $packageSourceMappingNode = $xml.configuration.packageSourceMapping
      if ($packageSourceMappingNode) {
          # Create new packageSource element for localpackages
          $sourceNode = $xml.CreateElement("packageSource")
          $sourceNode.SetAttribute("key", "localpackages")
          
          $packageNode = $xml.CreateElement("package")
          $packageNode.SetAttribute("pattern", "Microsoft.WindowsAppSDK*")
          $sourceNode.AppendChild($packageNode) | Out-Null
          
          # Insert at the beginning to prioritize
          if ($packageSourceMappingNode.HasChildNodes) {
              $packageSourceMappingNode.InsertBefore($sourceNode, $packageSourceMappingNode.FirstChild) | Out-Null
          } else {
              $packageSourceMappingNode.AppendChild($sourceNode) | Out-Null
          }
          Write-Host "Updated packageSourceMapping."
      }
      
      $xml.Save($nugetConfigPath)
      Get-Content $nugetConfigPath

- task: NuGetAuthenticate@1
  displayName: 'NuGet Authenticate'

- task: PowerShell@2
  displayName: Update WinAppSDK Versions
  inputs:
    filePath: '$(build.sourcesdirectory)\.pipelines\UpdateVersions.ps1'
    arguments: >
      -winAppSdkVersionNumber ${{ parameters.versionNumber }}
      -useExperimentalVersion $${{ parameters.useExperimentalVersion }}
      -rootPath "$(build.sourcesdirectory)"

- script: echo $(WinAppSDKVersion)
  displayName: 'Display WinAppSDK Version Found'

- task: NuGetCommand@2
  displayName: 'Restore NuGet packages'
  inputs:
    command: 'restore'
    feedsToUse: 'config'
    nugetConfigPath: '$(build.sourcesdirectory)\nuget.config'
    restoreSolution: '$(build.sourcesdirectory)\**\*.sln'
    includeNuGetOrg: false

- task: NuGetCommand@2
  displayName: 'Restore NuGet packages (slnx)'
  inputs:
    command: 'restore'
    feedsToUse: 'config'
    nugetConfigPath: '$(build.sourcesdirectory)\nuget.config'
    restoreSolution: '$(build.sourcesdirectory)\**\*.slnx'
    includeNuGetOrg: false
